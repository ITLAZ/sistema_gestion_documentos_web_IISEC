<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Estadísticas</title>
    <link rel="preload" href="../css/styles.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/styles.css"></noscript>
</head>
<body>
    <div id="menu-container"></div>
    <div class="container">
        <aside class="report-filter">
            <h2>Generación de Reportes</h2>
            <form id="report-form">
                <div class="input-group">
                    <label for="author">Nombre del Autor:</label>
                    <input type="text" id="author" name="author" pattern="[A-Za-zÀ-ÿáéíóúÁÉÍÓÚñÑ.&,\- ]*">
                </div>
                <div class="input-group">
                    <label for="startDate">Año Inicial:</label>
                    <input type="number" min="1900" max="2099" step="1" id="startDate" name="startDate">
                </div>
                <div class="input-group">
                    <label for="endDate">Año Final:</label>
                    <input type="number" min="1900" max="2099" step="1" id="endDate" name="endDate">
                </div>
                <div class="input-group">
                    <button type="submit">Generar Reporte</button>
                </div>
                <div class="input-group">
                    <button type="button" id="download-report">Descargar Reporte</button>
                </div>
            </form>
        </aside>

        <main class="report-container" id="report-container">
            <!-- Aquí se mostrará el reporte generado -->
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <script type="module">
        const form = document.getElementById('report-form');
        const reportContainer = document.getElementById('report-container');
        const downloadButton = document.getElementById('download-report');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Obtener los datos del formulario
        const author = document.getElementById('author').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        console.log('Datos del formulario:', { author, startDate, endDate });

        // Validaciones...
        if (!author && !startDate && !endDate) {
            alert('Debe ingresar al menos uno de los parámetros: autor, año de inicio o año final.');
            return;
        }

        if (startDate && !endDate) {
            alert('Debe ingresar un año final si ha ingresado un año de inicio.');
            return;
        }

        if (!startDate && endDate) {
            alert('Debe ingresar un año de inicio si ha ingresado un año final.');
            return;
        }

        if (parseInt(startDate) > parseInt(endDate)) {
            alert('El año inicial no puede ser mayor que el año final.');
            return;
        }

        if (parseInt(startDate) < 1900 || parseInt(endDate) < 1900) {
            alert('El año debe ser igual o mayor a 1900.');
            return;
        }

        console.log('Fechas validadas correctamente.');
        
        const url = `http://localhost:3000/reports/getAll?anioInicio=${startDate}&anioFin=${endDate}`;
        console.log('URL del endpoint:', url);
        
        try {
            const response = await fetch(url);
            console.log('Respuesta del fetch:', response);
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Datos recibidos del backend:', data);
            
            reportContainer.innerHTML = '';

            const filterByAuthor = (items, author) => {
                const lowerCaseAuthor = author.toLowerCase();
                return items.filter(item => 
                    item.autores.some(a => a.toLowerCase().includes(lowerCaseAuthor))
                );
            };

            const filteredLibros = filterByAuthor(data.libros, author);
            const filteredArticulos = filterByAuthor(data.articulosRevistas, author);
            const filteredCapitulos = filterByAuthor(data.capitulosLibros, author);
            const filteredDocumentosTrabajo = filterByAuthor(data.documentosTrabajo, author);
            const filteredIdeasReflexiones = filterByAuthor(data.ideasReflexiones, author);
            const filteredInfoIIsec = filterByAuthor(data.infoIIsec, author);
            const filteredPoliciesBriefs = filterByAuthor(data.policiesBriefs, author);

            // Crear contenedor de resumen
            const summaryContainer = document.createElement('div');
            summaryContainer.classList.add('summary-container');

        // Agregar el contenedor de resúmenes al contenedor del reporte
        reportContainer.appendChild(summaryContainer);

            // Calcular los totales
            const counts = [
                { type: 'Libros', count: filteredLibros.length },
                { type: 'Artículos', count: filteredArticulos.length },
                { type: 'Capítulos de Libros', count: filteredCapitulos.length },
                { type: 'Documentos de Trabajo', count: filteredDocumentosTrabajo.length },
                { type: 'Ideas y Reflexiones', count: filteredIdeasReflexiones.length },
                { type: 'Info IISEC', count: filteredInfoIIsec.length },
                { type: 'Policies Briefs', count: filteredPoliciesBriefs.length }
            ];

            const totalDocuments = counts.reduce((acc, item) => acc + item.count, 0);
            const maxCount = Math.max(...counts.map(item => item.count));
            const minCount = Math.min(...counts.map(item => item.count));

            const documentsWithMostResults = counts.filter(item => item.count === maxCount);
            const documentsWithLeastResults = counts.filter(item => item.count === minCount);

            // Función para crear tarjetas cuadradas de resumen
            const createSummaryCard = (title, value) => {
                const card = document.createElement('div');
                card.classList.add('summary-card');
                card.innerHTML = `
                    <h3>${title}</h3>
                    <p>${value}</p>
                `;
                return card;
            };

            // Generar descripciones para las tarjetas de "Más resultados" y "Menos resultados"
            const mostResultsDescription = documentsWithMostResults.map(item => `${item.type} (${item.count})`).join(', ');
            const leastResultsDescription = documentsWithLeastResults.map(item => `${item.type} (${item.count})`).join(', ');

            // Añadir las tarjetas de resumen
            summaryContainer.appendChild(createSummaryCard('Documento(s) con más resultados', mostResultsDescription));
            summaryContainer.appendChild(createSummaryCard('Total de documentos', `${totalDocuments} documentos`));
            summaryContainer.appendChild(createSummaryCard('Documento(s) con menos resultados', leastResultsDescription));

            // Agregar el contenedor de resúmenes al contenedor del reporte
            reportContainer.appendChild(summaryContainer);

            // Renderizar cada tipo de documento debajo de las tarjetas de resumen
            const renderSection = (sectionTitle, items, titleKey, dateKey) => {
                console.log(`Renderizando sección: ${sectionTitle} con ${items.length} elementos`);
                if (items.length > 0) {
                    const section = document.createElement('section');
                    section.classList.add('report-section');

                    // Crear encabezado
                    const header = document.createElement('h2');
                    header.textContent = `${sectionTitle} (${items.length})`;

                    // Crear lista
                    const ul = document.createElement('ul');
                    ul.classList.add('card-info');

                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item[titleKey]} - Publicado el ${item[dateKey]}`;
                        ul.appendChild(li);
                    });

                    // Agregar encabezado y lista a la sección
                    section.appendChild(header);
                    section.appendChild(ul);

                    // Agregar la sección al contenedor del reporte
                    reportContainer.appendChild(section);
                } else {
                    console.log(`No hay elementos para mostrar en la sección: ${sectionTitle}`);
                }
            };

            renderSection('Libros', filteredLibros, 'titulo', 'anio_publicacion');
            renderSection('Artículos', filteredArticulos, 'titulo', 'anio_revista');
            renderSection('Capítulos de Libros', filteredCapitulos, 'titulo_capitulo', 'anio_publicacion');
            renderSection('Documentos de Trabajo', filteredDocumentosTrabajo, 'titulo', 'anio_publicacion');
            renderSection('Ideas y Reflexiones', filteredIdeasReflexiones, 'titulo', 'anio_publicacion');
            renderSection('Info IISEC', filteredInfoIIsec, 'titulo', 'anio_publicacion');
            renderSection('Policies Briefs', filteredPoliciesBriefs, 'titulo', 'anio_publicacion');

            if (reportContainer.children.length === 1) { // Solo contiene el resumen y ningún otro resultado
                reportContainer.innerHTML += '<p>No se encontraron resultados para los criterios de búsqueda.</p>';
            }

        } catch (error) {
            console.error('Error al obtener el reporte:', error);
            reportContainer.innerHTML = '<p>Error al generar el reporte. Inténtalo de nuevo más tarde.</p>';
        }
    });



// Lógica para descargar el reporte como PDF
downloadButton.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("Reporte de Documentos", 10, 10);
    let y = 20;

    // Incluir la información de las tarjetas de resumen en el PDF
    const summaryCards = document.querySelectorAll('.summary-card');
    summaryCards.forEach(card => {
        const title = card.querySelector('h3').textContent;
        const value = card.querySelector('p').textContent;

        doc.text(`${title}: ${value}`, 10, y);
        y += 10;

        if (y > 280) { // Si el contenido supera el tamaño de la página, añadir una nueva página
            doc.addPage();
            y = 10;
        }
    });

    // Incluir los detalles de los documentos de cada sección
    const sections = reportContainer.querySelectorAll('.report-section');
    sections.forEach(section => {
        const header = section.querySelector('h2').textContent;
        doc.text(header, 10, y);
        y += 10;

        const items = section.querySelectorAll('li');
        items.forEach(item => {
            if (y > 280) { // Si el contenido supera el tamaño de la página, añadir una nueva página
                doc.addPage();
                y = 10;
            }
            doc.text(item.textContent, 10, y);
            y += 10;
        });
    });

    // Descargar el PDF
    doc.save('reporte.pdf');
});




    </script>
</body>
</html>
<script src="js/main.js" type="module"></script>