<!DOCTYPE html>
<html lang="es" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Estadísticas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        // Leer la cookie directamente y establecer el atributo de tema al cargar la página
        (function () {
          function getCookieValue(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
          }
    
          const theme = getCookieValue('theme') || 'light'; // Default a 'light' si no hay cookie
          document.documentElement.setAttribute('data-theme', theme);
        })();
      </script>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div id="menu-container"></div>
    <div class="container">

        <!-- Formulario de generación de reportes -->
        <aside class="report-filter">
            <h2>Generación de Reportes</h2>
            <form id="report-form">
                <div class="input-group">
                    <label for="category">Tipo de Documento:</label>
                    <select id="category" name="category" required>
                        <option value="null" disabled selected>Seleccione una categoría</option>
                        <option value="all-types">Todos los documentos</option>
                        <option value="libros">Libros</option>
                        <option value="articulosRevistas">Artículos de Revista</option>
                        <option value="capitulosLibros">Capítulos de Libros</option>
                        <option value="documentosTrabajo">Documentos de Trabajo</option>
                        <option value="ideasReflexiones">Ideas y Reflexiones</option>
                        <option value="infoIIsec">Info IISEC</option>
                        <option value="policiesBriefs">Policies Briefs</option>
                    </select>
                </div>


                <div class="input-group">
                    <label for="author">Nombre del Autor:</label>
                    <input type="text" id="author" name="author" pattern="[A-Za-zÀ-ÿáéíóúÁÉÍÓÚñÑ.&,\- ]*">
                </div>
                <div class="input-group">
                    <label for="startDate">Año Inicial:</label>
                    <input type="number" min="1900" max="2099" step="1" id="startDate" name="startDate">
                </div>
                <div class="input-group">
                    <label for="endDate">Año Final:</label>
                    <input type="number" min="1900" max="2099" step="1" id="endDate" name="endDate">
                </div>
                <div id="compare-selection" class="compare-selection">
                    <h3>Documentos adicionales a mostrar (conteo):</h3>
                    <label><input type="checkbox" name="docType" value="libros"> Libros</label>
                    <label><input type="checkbox" name="docType" value="articulosRevistas"> Articulos de Revista</label>
                    <label><input type="checkbox" name="docType" value="capitulosLibros"> Capitulos de Libros</label>
                    <label><input type="checkbox" name="docType" value="documentosTrabajo"> Documentos de
                        Trabajo</label>
                    <label><input type="checkbox" name="docType" value="ideasReflexiones"> Ideas y Reflexiones</label>
                    <label><input type="checkbox" name="docType" value="infoIIsec"> Info IISEC</label>
                    <label><input type="checkbox" name="docType" value="policiesBriefs"> Policies Briefs</label>
                </div>
                <div class="input-group button-group">
                    <button type="submit" class="btn-small">Generar</button>
                    <button type="button" id="download-report" class="btn-small">Descargar</button>
                </div>
            </form>
        </aside>

        <div class="graph-container">
            <!-- Selección de tipo de gráfico (fuera del formulario, en la parte superior del contenedor de reportes) -->
            <div class="chart-selection">
                <h3>Selecciona el tipo de gráfico:</h3>
                <label><input type="radio" name="chartType" value="bar" checked> Barra</label>
                <label><input type="radio" name="chartType" value="line"> Línea</label>
                <label><input type="radio" name="chartType" value="pie"> Torta</label>
                <label><input type="radio" name="chartType" value="none"> Sin Gráfico</label>
            </div>

            <!-- Contenedor de reportes -->
            <main class="report-container" id="report-container">
                <!-- Aquí se mostrará el reporte generado y el gráfico -->
            </main>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    

    <script type="module">

        import * as Swal from '/node_modules/sweetalert2/dist/sweetalert2.js';

        const form = document.getElementById('report-form');
        const reportContainer = document.getElementById('report-container');
        const downloadButton = document.getElementById('download-report');
        const categorySelect = document.getElementById('category');
        const compareSelection = document.getElementById('compare-selection');
        import { API_URL } from '../../config.js';


        const labelMapping = {
            libros: 'Libros',
            articulosRevistas: 'Artículos en Revista',
            capitulosLibros: 'Capítulos de Libros',
            documentosTrabajo: 'Documentos de Trabajo',
            ideasReflexiones: 'Ideas y Reflexiones',
            policiesBriefs: 'Policy Brief',
            infoIIsec: 'Info IISEC',
            "all-types": "Todos los documentos"
        };

        // Función para crear una tarjeta
        const createDataCard = (title, content) => {
            const card = document.createElement('div');
            card.classList.add('data-card'); // Clase CSS para estilos
            card.innerHTML = `
                <h4>${title}</h4>
                <p>${content}</p>
            `;
            return card;
        };

        // Función para generar tarjetas de datos asociadas a cada gráfico
        const renderDataCards = (data, container, title) => {
            container.innerHTML = ''; // Limpia las tarjetas previas

            // Generar tarjetas con datos
            if (Array.isArray(data)) {
                // Si los datos son una lista (como documentos por categoría o años)
                data.forEach((item) => {
                    const { label, value } = item;
                    container.appendChild(createDataCard(`${title} - ${label}`, `${value}`));
                });
            } else {
                // Si los datos son un objeto (como tipos por año)
                Object.keys(data).forEach((key) => {
                    const value = data[key];
                    container.appendChild(createDataCard(`${title} - ${key}`, `${value}`));
                });
            }
        };

        // Seleccionar automáticamente el checkbox basado en la categoría seleccionada en el combo box
        categorySelect.addEventListener('change', function () {
            const selectedCategory = categorySelect.value;

            // Si se selecciona una categoría específica, marca el checkbox correspondiente y muestra el selector de comparación
            if (selectedCategory && selectedCategory !== 'all-types') {
                compareSelection.style.display = 'block';

                // Desmarca todos los checkboxes
                compareSelection.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Marca el checkbox de la categoría seleccionada en el combo box
                const selectedCheckbox = compareSelection.querySelector(`input[value="${selectedCategory}"]`);
                if (selectedCheckbox) {
                    selectedCheckbox.checked = true;
                }
            } else {
                // Si se selecciona "Todos los documentos", oculta el selector de comparación y desmarca los checkboxes
                compareSelection.style.display = 'none';
                compareSelection.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        });

        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            // Obtener los datos del formulario
            const category = document.getElementById('category').value;
            const author = document.getElementById('author').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            console.log('Datos del formulario:', { category, author, startDate, endDate });

            // Validaciones
            if (!author && !startDate && !endDate) {
                Sweetalert2.fire('Debe ingresar al menos uno de los parámetros: autor, año de inicio o año final.');
                return;
            }

            if (startDate && !endDate) {
                Sweetalert2.fire('Debe ingresar un año final si ha ingresado un año de inicio.');
                return;
            }

            if (!startDate && endDate) {
                Sweetalert2.fire('Debe ingresar un año de inicio si ha ingresado un año final.');
                return;
            }

            if (parseInt(startDate) > parseInt(endDate)) {
                Sweetalert2.fire('El año inicial no puede ser mayor que el año final.');
                return;
            }

            console.log('Fechas validadas correctamente.');

            // Construir la URL según la selección en el combo box
            let url;
            if (category === "all-types") {
                url = `${API_URL}/reports/getAll?anioInicio=${startDate}&anioFin=${endDate}&autores=${author}`;
            } else {
                url = `${API_URL}/reports/getByType?categoria=${category}&anioInicio=${startDate}&anioFin=${endDate}&autores=${author}`;
            }

            console.log(`URL del endpoint ${category === "all-types" ? 'general' : 'filtrado por categoría'}:`, url);

            try {
                const response = await fetch(url);
                console.log("RESPONSE",response);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log("DATA",data);

                if (!data || (Array.isArray(data) && data.length === 0)) {
                    reportContainer.innerHTML = '<p>No hay resultados disponibles para los filtros seleccionados.</p>';
                    return; // Detener el procesamiento si no hay datos
                }

                reportContainer.innerHTML = '';

                // Preparar datos filtrados para una categoría específica
                let filteredData;
                if (category === "all-types") {
                    filteredData = {
                        libros: data.libros || [],
                        articulosRevistas: data.articulosRevistas || [],
                        capitulosLibros: data.capitulosLibros || [],
                        documentosTrabajo: data.documentosTrabajo || [],
                        ideasReflexiones: data.ideasReflexiones || [],
                        infoIIsec: data.infoIIsec || [],
                        policiesBriefs: data.policiesBriefs || []
                    };
                } else {
                    // Solo datos de la categoría específica
                    filteredData = data;
                }


                // Crear contenedor de resumen solo si se selecciona "Todos los documentos"
                if (category === "all-types") {
                    const summaryContainer = document.createElement('div');
                    summaryContainer.classList.add('summary-container');
                    reportContainer.appendChild(summaryContainer);

                    // Calcular los totales
                    const counts = Object.keys(filteredData).map(type => ({
                        type,
                        count: filteredData[type].length
                    }));

                    const totalDocuments = counts.reduce((acc, item) => acc + item.count, 0);
                    const maxCount = Math.max(...counts.map(item => item.count));
                    const minCount = Math.min(...counts.map(item => item.count));

                    const documentsWithMostResults = counts.filter(item => item.count === maxCount);
                    const documentsWithLeastResults = counts.filter(item => item.count === minCount);

                    // Crear tarjetas de resumen
                    const createSummaryCard = (title, value) => {
                        const card = document.createElement('div');
                        card.classList.add('summary-card');
                        card.innerHTML = `
                            <h3>${title}</h3>
                            <p>${value}</p>
                        `;
                        return card;
                    };

                    const mostResultsDescription = documentsWithMostResults
                        .map((item) => `${labelMapping[item.type] || item.type} (${item.count})`)
                        .join(', ');

                    const leastResultsDescription = documentsWithLeastResults
                        .map((item) => `${labelMapping[item.type] || item.type} (${item.count})`)
                        .join(', ');

                    summaryContainer.appendChild(createSummaryCard('Documento con más resultados', mostResultsDescription));
                    summaryContainer.appendChild(createSummaryCard('Total de documentos', `${totalDocuments} documentos`));
                    summaryContainer.appendChild(createSummaryCard('Documento(s) con menos resultados', leastResultsDescription));
                }

                // Renderizar listado en reportContainer para una categoría específica
                const renderSection = (sectionTitle, items) => {
                    if (items.length > 0) {
                        const section = document.createElement('section');
                        section.classList.add('report-section');

                        const header = document.createElement('h2');
                        header.textContent = `${sectionTitle} (${items.length})`;

                        const ul = document.createElement('ul');
                        ul.classList.add('card-info');

                        items.forEach(item => {
                            const li = document.createElement('li');
                            const titulo = item.titulo || item.titulo_capitulo;
                            const anio = item.anio_publicacion || item.anio_revista;
                            const autores = item.autores ? `Autores: ${item.autores}` : 'Autores no disponibles';

                            li.textContent = `${titulo} - Publicado el ${anio} - ${autores}`;
                            ul.appendChild(li);
                        });

                        section.appendChild(header);
                        section.appendChild(ul);
                        reportContainer.appendChild(section);
                    }
                };

                if (category === "all-types") {
                    renderSection('Libros', filteredData.libros);
                    renderSection('Artículos en Revista', filteredData.articulosRevistas);
                    renderSection('Capítulos de Libros', filteredData.capitulosLibros);
                    renderSection('Documentos de Trabajo', filteredData.documentosTrabajo);
                    renderSection('Ideas y Reflexiones', filteredData.ideasReflexiones);
                    renderSection('Info IISEC', filteredData.infoIIsec);
                    renderSection('Policy Brief', filteredData.policiesBriefs);
                } else {
                    renderSection(category.charAt(0).toUpperCase() + category.slice(1), filteredData);
                }

                // Generar gráficos según las condiciones
                const chartType = document.querySelector('input[name="chartType"]:checked').value;

                let chartContainer = document.getElementById('chart-container');
                if (!chartContainer) {
                    chartContainer = document.createElement('div');
                    chartContainer.id = 'chart-container';
                    reportContainer.appendChild(chartContainer);
                }

                // Si se selecciona "Sin Gráfico", salimos de la función aquí para no crear gráficos
                if (chartType === 'none') {
                    chartContainer.innerHTML = ''; // Asegura que el contenedor esté vacío
                    return;
                }

                chartContainer.innerHTML = '';


                if (category === "all-types") {
                    // Realiza una solicitud al endpoint countByTypes para el primer gráfico
                    const countByTypesResponse = await fetch(`${API_URL}/reports/countByTypes?anioInicio=${startDate}&anioFin=${endDate}&autores=${author}`);
                    if (!countByTypesResponse.ok) throw new Error('Error al obtener el conteo por tipos');
                    const countByTypesData = await countByTypesResponse.json();
                    
                    
                    // Gráfico de Conteo de Documentos por Categoría

                    // Generar tarjetas
                    const cardContainer1 = document.createElement('div');
                    cardContainer1.classList.add('card-container');

                    // Asignar la categoría al contenedor
                    cardContainer1.setAttribute('data-category', 'Documentos por Categoría');
                    chartContainer.appendChild(cardContainer1);

                    const ctx1 = document.createElement('canvas');
                    chartContainer.appendChild(ctx1);

                    ctx1.setAttribute('data-category', "Documentos por Categoría"); 

                    new Chart(ctx1, {
                        type: chartType,
                        data: {
                            labels: countByTypesData.map(item => labelMapping[item.tipo] || item.tipo),
                            datasets: [{
                                label: 'Conteo de Documentos por Categoría',
                                data: countByTypesData.map(item => item.cantidad),
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        }
                    });

                    renderDataCards(
                        
                        countByTypesData.map(item => ({ label: labelMapping[item.tipo] || item.tipo, value: `${item.cantidad} documentos` })),
                        cardContainer1,
                        'Documentos por Categoría'
                    );


                    // Gráficos adicionales solo si se especifica un rango de años
                    if (startDate || endDate) {
                        // Gráfico 1: Cantidad total de documentos por año
                        const documentsByYear = {};
                        Object.values(filteredData).forEach(items => {
                            items.forEach(item => {
                                const year = item.anio_publicacion || item.anio_revista;
                                if (year) {
                                    documentsByYear[year] = (documentsByYear[year] || 0) + 1;
                                }
                            });
                        });

                        // Generar tarjetas
                        const cardContainer2 = document.createElement('div');
                        cardContainer2.classList.add('card-container');
                        // Asignar la categoría al contenedor
                        cardContainer2.setAttribute('data-category', 'Documentos por Año');
                        chartContainer.appendChild(cardContainer2);

                        const ctx2 = document.createElement('canvas');
                        chartContainer.appendChild(ctx2);

                        ctx2.setAttribute('data-category', "Documentos por Año"); 

                        new Chart(ctx2, {
                            type: chartType,
                            data: {
                                labels: Object.keys(documentsByYear),
                                datasets: [{
                                    label: 'Cantidad de Documentos por Año',
                                    data: Object.values(documentsByYear),
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }]
                            }
                        });

                        renderDataCards(
                            Object.entries(documentsByYear).map(([year, count]) => ({ label: year, value: `${count} documentos` })),
                            cardContainer2,
                            'Documentos por Año'
                        );

                        // Gráfico 2: Tipo de documentos por año
                        const typesByYear = {};
                        Object.keys(filteredData).forEach(type => {
                            filteredData[type].forEach(item => {
                                const year = item.anio_publicacion || item.anio_revista;
                                if (year) {
                                    if (!typesByYear[year]) {
                                        typesByYear[year] = { 
                                            libros: 0, 
                                            articulosRevistas: 0, 
                                            capitulosLibros: 0, 
                                            documentosTrabajo: 0, 
                                            ideasReflexiones: 0, 
                                            infoIIsec: 0, 
                                            policiesBriefs: 0 
                                        };
                                    }
                                    typesByYear[year][type] += 1;
                                }
                            });
                        });

                        const years = Object.keys(typesByYear);

                        // Crear contenedor de tarjetas antes del gráfico
                        const cardContainer3 = document.createElement('div');
                        cardContainer3.classList.add('card-container');
                        // Asignar la categoría al contenedor
                        cardContainer3.setAttribute('data-category', 'Tipo de Documentos por Año');
                        chartContainer.appendChild(cardContainer3);

                        // Generar tarjetas por año
                        years.forEach(year => {
                            const yearData = typesByYear[year];

                            // Filtrar solo los tipos que tienen datos (no cero)
                            const validTypes = Object.entries(yearData)
                                .filter(([type, count]) => count > 0)
                                .map(([type, count]) => [labelMapping[type] || type, count]);

                            // Si no hay datos válidos, no generar una tarjeta para este año
                            if (validTypes.length === 0) return;

                            // Crear tarjeta única para este año
                            const card = document.createElement('div');
                            card.classList.add('data-card');

                            // Título del año
                            const title = document.createElement('h4');
                            title.textContent = `Año ${year}`;
                            card.appendChild(title);

                            // Lista de tipos y cantidades
                            const content = document.createElement('p'); 
                            content.textContent = validTypes.map(([type, count]) => `[${type}: ${count}]`).join(' ');
                            card.appendChild(content);

                            // Agregar la tarjeta al contenedor
                            cardContainer3.appendChild(card);
                        });

                        // Crear el gráfico después de las tarjetas
                        const ctx3 = document.createElement('canvas');
                        chartContainer.appendChild(ctx3);

                        ctx3.setAttribute('data-category', 'Tipo de Documentos por Año'); // Asignamos el atributo 'data-category' al canvas

                        new Chart(ctx3, {
                            type: chartType,
                            data: {
                                labels: years,
                                datasets: Object.keys(filteredData).map(type => ({
                                    label: `Cantidad de ${labelMapping[type] || type} por Año`,
                                    data: years.map(year => typesByYear[year][type] || 0),
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }))
                            }
                        });

                    }
                }
                else {
                    const yearCounts = {};
                    filteredData.forEach(item => {
                        const year = item.anio_publicacion || item.anio_revista;
                        if (year) {
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        }
                    });

                    // Generar tarjetas con los datos de yearCounts
                    const cardContainer = document.createElement('div');
                    cardContainer.classList.add('card-container');
                    cardContainer.setAttribute('data-category', `Documentos de ${labelMapping[category] || category}`);
                    chartContainer.appendChild(cardContainer);


                    // Crear gráfico principal para la categoría específica
                    const ctx = document.createElement('canvas');
                    chartContainer.appendChild(ctx);

                    ctx.setAttribute('data-category', `Documentos de ${labelMapping[category] || category}`);
                    new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: Object.keys(yearCounts),
                            datasets: [{
                                label: `Documentos en ${labelMapping[category] || category} por Año`,
                                data: Object.values(yearCounts),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        }
                    });

                    renderDataCards(
                        Object.entries(yearCounts).map(([year, count]) => ({ label: `Año ${year}`, value: `${count} documentos publicados en ${labelMapping[category] || category}` })),
                        cardContainer,
                        `Datos`
                    );

                    // Obtener las categorías seleccionadas en los checkboxes
                    const selectedCheckboxes = Array.from(compareSelection.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);

                    // Si hay dos o más categorías seleccionadas, genera el gráfico adicional
                    if (selectedCheckboxes.length >= 2) {
                        generateAdditionalChart(selectedCheckboxes, startDate, endDate);
                    }
                }

            } catch (error) {
                console.error('Error al obtener el reporte:', error);
                reportContainer.innerHTML = '<p>Error al generar el reporte. Inténtalo de nuevo más tarde.</p>';
            }
        });


        // Función para generar un gráfico adicional con las categorías seleccionadas
        async function generateAdditionalChart(selectedCategories, startDate, endDate) {
            const chartContainer = document.getElementById('chart-container');
            if (!chartContainer) return;

            try {
                // Construir la URL para el gráfico adicional
                const params = new URLSearchParams();
                selectedCategories.forEach(category => params.append('categorias', category));
                params.append('anioInicio', startDate);
                params.append('anioFin', endDate);

                const additionalChartUrl = `${API_URL}/reports/countByTypes?${params.toString()}`;
                console.log(`URL para el gráfico adicional: ${additionalChartUrl}`);

                const response = await fetch(additionalChartUrl);
                if (!response.ok) {
                    throw new Error('Error al obtener datos para el gráfico adicional');
                }

                const additionalData = await response.json();

                // Generar tarjetas con los datos de additionalData
                const additionalCardContainer = document.createElement('div');
                additionalCardContainer.classList.add('card-container');
                // Asignar la categoría al contenedor
                additionalCardContainer.setAttribute('data-category', 'Datos por Categoría Seleccionada');
                chartContainer.appendChild(additionalCardContainer);

                // Crear un nuevo gráfico en el contenedor
                const additionalCtx = document.createElement('canvas');
                chartContainer.appendChild(additionalCtx);

                additionalCtx.setAttribute('data-category', 'Datos por Categoría Seleccionada');

                const chartType = document.querySelector('input[name="chartType"]:checked').value;

                new Chart(additionalCtx, {
                    type: chartType,
                    data: {
                        labels: additionalData.map(item => item.tipo),
                        datasets: [{
                            label: 'Conteo de Documentos por Categoría Seleccionada',
                            data: additionalData.map(item => item.cantidad),
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    }
                });

                renderDataCards(
                    additionalData.map(item => ({ label: item.tipo, value: `${item.cantidad} documentos` })),
                    additionalCardContainer,
                    'Datos por Categoría Seleccionada'
                );
            } catch (error) {
                console.error('Error al generar el gráfico adicional:', error);
            }
        }

    //LOGICA PARA DESCARGAR
    downloadButton.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Formato A4, orientación vertical
    const margin = 10; // Márgenes en mm
    const pageWidth = doc.internal.pageSize.width - 2 * margin;
    const pageHeight = doc.internal.pageSize.height - 2 * margin;

    const reportContainer = document.getElementById('report-container');
    const chartContainer = document.getElementById('chart-container');
    const summaryContainer = document.querySelector('.summary-container');

    // Obtener parámetros de búsqueda
    const categoryValue = document.getElementById('category').value || "all-types";
    const tipoDocumento = labelMapping[categoryValue] || "Sin especificar";
    const nombreAutor = document.getElementById('author').value || "Todos los Autores";
    const anioInicio = document.getElementById('startDate').value || "Sin especificar";
    const anioFin = document.getElementById('endDate').value || "Sin especificar";

    try {
        let y = margin;

        // ** Encabezado del PDF **
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(16);
        doc.text("REPORTE GENERADO", pageWidth / 2 + margin, y, { align: "center" });
        y += 20;

        // ** Añadir parámetros de búsqueda **
        doc.setFontSize(12);
        doc.setFont("Helvetica", "bold");
        doc.text(`Tipo de Documento:`, margin, y);
        doc.setFont("Helvetica", "normal");
        doc.text(`${tipoDocumento}`, margin + 50, y);
        y += 10;

        doc.setFont("Helvetica", "bold");
        doc.text(`Nombre del Autor:`, margin, y);
        doc.setFont("Helvetica", "normal");
        doc.text(`${nombreAutor}`, margin + 50, y);
        y += 10;

        doc.setFont("Helvetica", "bold");
        doc.text(`Rango de Años:`, margin, y);
        doc.setFont("Helvetica", "normal");
        doc.text(`${anioInicio} - ${anioFin}`, margin + 50, y);
        y += 20;

        // ** Incluir contenido del summary-container (si existe) **
        if (summaryContainer) {
            const summaryData = Array.from(summaryContainer.querySelectorAll('.summary-card')).map((card) => {
                const title = card.querySelector('h3')?.innerText || "Sin título";
                const value = card.querySelector('p')?.innerText || "Sin datos";
                return { title, value };
            });

            summaryData.forEach(({ title, value }) => {
                doc.setFont("Helvetica", "bold");
                doc.text(title, margin, y);
                y += 10;

                doc.setFont("Helvetica", "normal");
                const textLines = doc.splitTextToSize(value, pageWidth);
                textLines.forEach((line) => {
                    if (y + 10 > pageHeight) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, margin, y);
                    y += 4;
                });

                y += 10;
            });
        }

        // ** Título del listado de documentos **
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(14);
        doc.text("LISTADO DE DOCUMENTOS", pageWidth / 2 + margin, y, { align: "center" });
        y += 15;

        // ** Listado del report-container **
        const sections = reportContainer.querySelectorAll("section");
        sections.forEach((section) => {
            const title = section.querySelector("h2, h3")?.innerText || "Sin título";
            const items = Array.from(section.querySelectorAll("li"));

            doc.setFontSize(14);
            doc.setFont("Helvetica", "bold");
            if (y + 10 > pageHeight) {
                doc.addPage();
                y = margin;
            }
            doc.text(title, margin, y);
            y += 10;

            doc.setFontSize(11);
            doc.setFont("Helvetica", "normal");
            items.forEach((item, index) => {
                const number = `${index + 1}.`;
                const text = item.innerText || item.textContent || "";

                if (y + 10 > pageHeight) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFont("Helvetica", "bold");
                doc.text(number, margin, y);
                doc.setFont("Helvetica", "normal");
                doc.text(text, margin + 10, y);
                y += 10;
            });

            y += 10;
        });

        // ** Crear una nueva página para los gráficos y las imágenes de las tarjetas **
        doc.addPage();
        y = margin;

        // ** Título para las tarjetas y gráficos **
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(14);
        doc.text("GRÁFICOS Y TARJETAS", pageWidth / 2 + margin, y, { align: "center" });
        y += 15;

        // ** Añadir imágenes de las tarjetas y gráficos (de la primera función) **
        const cardContainers = document.querySelectorAll('.card-container');
        const categories = {};

        // Agrupar card-containers por categoría
        cardContainers.forEach(card => {
            const category = card.getAttribute('data-category') || "Sin categoría";
            if (!categories[category]) {
                categories[category] = { cards: [], canvases: [] };
            }
            categories[category].cards.push(card);
        });

        // Agrupar canvases por categoría
        const canvases = chartContainer.querySelectorAll('canvas');
        canvases.forEach(canvas => {
            const category = canvas.getAttribute('data-category') || "Sin categoría";
            if (!categories[category]) {
                categories[category] = { cards: [], canvases: [] };
            }
            categories[category].canvases.push(canvas);
        });

        for (const category in categories) {
            // ** Título de la categoría **
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(12);
            if (y + 10 > pageHeight) {
                doc.addPage();
                y = margin;
            }
            doc.text(`Categoría: ${category}`, margin, y);
            y += 5; // Reducido espacio entre el título de la categoría y las tarjetas/gráficos

            // ** Imprimir las card-containers (tarjetas) de esta categoría **
            const { cards, canvases } = categories[category];

            // Procesar las tarjetas
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const cardImage = await html2canvas(card, {
                    scale: 2, // Mejor calidad
                    useCORS: true, // Permitir recursos externos
                });

                const imgData = cardImage.toDataURL("image/png");
                const imgWidth = pageWidth - 2 * margin; // Ancho ajustado al ancho de la página
                const imgHeight = (cardImage.height / cardImage.width) * imgWidth; // Mantener proporción

                if (y + imgHeight > pageHeight) {
                    doc.addPage();
                    y = margin;
                }

                doc.addImage(imgData, "PNG", margin, y, imgWidth, imgHeight);
                y += imgHeight; // Ajustar la posición sin espacio extra
            }

            // ** Imprimir los canvases (gráficos) de esta categoría **
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                if (canvas.getAttribute('data-category') === category) {
                    const canvasImage = await html2canvas(canvas, {
                        scale: 2, // Mejor calidad
                        useCORS: true, // Permitir recursos externos
                    });

                    const imgData = canvasImage.toDataURL("image/png");
                    const imgWidth = 180; // Ancho ajustado
                    const imgHeight = (canvasImage.height / canvasImage.width) * imgWidth; // Mantener proporción

                    if (y + imgHeight > pageHeight) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.addImage(imgData, "PNG", margin, y, imgWidth, imgHeight);
                    y += imgHeight; // Ajustar la posición sin espacio extra
                }
            }

            // Añadir un pequeño espacio después de cada categoría para separar el contenido
            y += 10;
        }

            // Descargar el PDF
            doc.save('reporte_completo.pdf');
            Sweetalert2.fire("El PDF se generó exitosamente.");
        } catch (error) {
            console.error("Error al generar el PDF:", error);
            Sweetalert2.fire("Hubo un error al generar el PDF.");
        }
    });

    </script>
</body>

</html>
<script src="../js/main.js" type="module"></script>